<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Use correct character set. -->
    <meta charset="utf-8" />
    <!-- Tell IE to use the latest, best version. -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <title>Hello World!</title>
    <script src="../Build/Cesium/Cesium.js"></script>
    <style>
      @import url(../Build/Cesium/Widgets/widgets.css);
      html,
      body,
      #cesiumContainer {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
      
      #contextmenu {
        display:none;
        position:fixed;
        left:0px;
        top:0px;
        widows: 150px;
        height:100px;
        background-color:#f0f0f0;
        border:1px solid #eee;
      }

      #contextmenu.show {
        display: block;
      }
    </style>
  </head>
  <body>
    <div id="cesiumContainer"></div>
    
    <!-- コンテキストメニュー -->
    <div id="contextmenu" class="contextmenu"> 
        <input type="button" value="経度緯度高さ" onclick="menu1()">
        <input type="button" value="点字ブロック設置" onclick="menu2()">
        <input type="button" value="点字ブロック撤去" onclick="menu3()">
    </div>
    
    
    <script>
      var viewer = new Cesium.Viewer("cesiumContainer");
//       const buildingTileset = viewer.scene.primitives.add(Cesium.createOsmBuildings());
//       viewer.dataSources.add(Cesium.CzmlDataSource.load(czml));
//       viewer.dataSources.add(Cesium.CzmlDataSource.load("./SampleData/Vehicle.czml"));
//       viewer.dataSources.add(Cesium.GeoJsonDataSource.load("./SampleData/abe.geojson"));
//       viewer.dataSources.add(Cesium.GeoJsonDataSource.load("./SampleData/abe.czml"));
      
      let con = document.getElementById('contextmenu'); 
      //経度緯度高さ
      var longitudeString = 0;
      var latitudeString = 0;
      var heightString = 0;
      
      // 地球上で右クリック押下→コンテキストメニュー表示
      viewer.canvas.addEventListener('contextmenu', function(e){ // right click
          var mousePosition = new Cesium.Cartesian2(e.clientX, e.clientY);
          var ellipsoid = viewer.scene.globe.ellipsoid; // Gets an ellipsoid describing the shape of this globe.
          var cartesian = viewer.camera.pickEllipsoid(mousePosition, ellipsoid);
          if (cartesian) {
              var cartographic = ellipsoid.cartesianToCartographic(cartesian);
              longitudeString = Cesium.Math.toDegrees(cartographic.longitude).toFixed(2);
              latitudeString = Cesium.Math.toDegrees(cartographic.latitude).toFixed(2);
              heightString = Cesium.Math.toDegrees(cartographic.height).toFixed(2); // 	0.0	optionalThe height, in meters, above the ellipsoid.
              console.log(`cartographic=${cartographic}`);
              console.log(`heightString=${heightString}`);

//               alert(longitudeString + ', ' + latitudeString); 
              con.style.left = e.pageX + 'px';
              con.style.top = e.pageY + 'px';
              con.classList.add('show');
          } else {
              alert('Globe was not picked');
          }
      }, false);
      
      // 左クリック押下→コンテキストメニュー非表示
      viewer.canvas.addEventListener('click', function(e){ // left click
        con.classList.remove('show');
      }, false);
      
      // メニュー1押下→経度緯度高さ情報表示
      function menu1(){
        alert(longitudeString + ', ' + latitudeString + ', ' + heightString); 
        con.classList.remove('show');
      }
      
      // メニュー2押下→画像を配置
      function menu2(){
//         var czml = [
//                     {
//                       id: "document",
//                       version: "1.0"
//                     },
//                     {
//                       "id" : "1",
//                       "description" : "点字ブロック設置",
//                       "position" : {
//                         "cartographicDegrees": [longitudeString,latitudeString,heightString]
//                       },
//                       "billboard" : {
//                         "image" : "./SampleData/cesium_stripes.png",
//                         "scale" : 0.2
//                       },
//                      }
//                     ]
//         viewer.dataSources.add(Cesium.CzmlDataSource.load(czml));
        // 画像設置
        var entity = viewer.entities.add({
          name : '点字ブロック設置',
          position : Cesium.Cartesian3.fromDegrees(longitudeString,latitudeString,heightString),
          billboard : {
                        image : "./SampleData/cesium_stripes.png",
                        scale : 0.2
          },
        });
        viewer.zoomTo(viewer.entities); //zoom
        con.classList.remove('show'); // コンテキストメニュー非表示
        
        // zoomして画像動かすと、動かしているとき消える
        var mousePosition = new Cesium.Cartesian2();
        var mousePositionProperty = new Cesium.CallbackProperty(function(time, result){ //値がコールバック関数によって遅延評価されるプロパティ。
            var position = scene.camera.pickEllipsoid(mousePosition, undefined, result);
            console.log(`position=${position}`);
            var cartographic = Cesium.Ellipsoid.WGS84.cartesianToCartographic(position); //デカルトを作成し、WGS84(アメリカで構築・維持されている世界測地系)楕円体でのデカルト表現を決定します。
          
//             var cartographic = Cesium.Ellipsoid.cartesianToCartographic(position); //×
            console.log(`cartographic=${cartographic}`);
            cartographic.height = 300000.0;
            return Cesium.Ellipsoid.WGS84.cartographicToCartesian(cartographic);
        }, false);

        var scene = viewer.scene;
        var dragging = false;
        var handler = new Cesium.ScreenSpaceEventHandler(viewer.canvas); //画像移動のイベントリスナーを設置
        handler.setInputAction(
            function(click) {
                var pickedObject = scene.pick(click.position);
                console.log(`pickedObject=${pickedObject}`);
                if (Cesium.defined(pickedObject) && (pickedObject.id === entity)) {
                    dragging = true;
                    scene.screenSpaceCameraController.enableRotate = false; //trueの場合、ユーザーがワールドを回転できるようにします　false回転禁止
                    Cesium.Cartesian2.clone(click.position, mousePosition); //複製
                    entity.position = mousePositionProperty; //画像の位置はマウス移動の位置
                }
            },
            Cesium.ScreenSpaceEventType.LEFT_DOWN //左ボタンダウンイベント
        );

        handler.setInputAction(
            function(movement) {
                if (dragging) {
                    Cesium.Cartesian2.clone(movement.endPosition, mousePosition);
                }
            },
            Cesium.ScreenSpaceEventType.MOUSE_MOVE //マウス移動のイベント
        );


        handler.setInputAction(
            function(click) {
                if(dragging) {
                  dragging = false;
                  scene.screenSpaceCameraController.enableRotate = true;
                  entity.position = scene.camera.pickEllipsoid(click.position);
                }
            },
            Cesium.ScreenSpaceEventType.LEFT_UP //左ボタンアップイベント
        );
        
        // 画像撤去
        handler.setInputAction(
            function(rightclick) {
                entities.remove(entity);
            },
            Cesium.Cesium.ScreenSpaceEventType.RIGHT_DOWN //右ボタンダウンイベント
        );
        
      } //ダブルクリックすると画像視点になる?
      

              
    </script>
  </body>
</html>
